# MEMO

## ネットワーク帯域制限ルールを持たせたパイプを作成する

Dummy Net Control (dnctl)
```
dnctl
```

役割: macOS（およびFreeBSD）に搭載されている 「トラフィック・シェイパー（通信整形器）」 を操作するツールです。

イメージ: インターネットという水の流れに対して、「蛇口の締め具合」や「管の長さ（遅延）」を管理するコントローラーです。これ自体は「どのデータを絞るか」は決めず、あくまで「絞り方（ルール）」を定義します。

Network Link Conditioner (GUI): マウスでポチポチ操作する画面。中身は dnctl と pfctl を裏で自動実行しているだけ です。


パラメーター,意味,単位,研究での使い所
bw,帯域幅,"Mbit/s, Kbit/s",スループット制限（基本）
delay,遅延,ms,物理的な距離や中継による遅れ
plr,パケットロス率,0.0 〜 1.0,不安定な無線環境の再現
queue,キュー容量,slots / KB,大量リクエスト時の耐性テスト




Packet Filter Control (pfctl)

参考ブログ：

Macで自由にパケットのフィルタリング、帯域制限、パケロス率の設定をする
https://spring-mt.hatenablog.com/entry/2022/09/22/234405




シェルスクリプト独特の書き方なので、初めて見ると「暗号」のように見えますよね。 これらは**「複数の行をひとまとめにして、次のコマンドに一気に放り込む」**ためのテクニックです。

一つずつ解剖していきましょう。

1. cat とは何？
Catenate（連結する）の略です。

本来の役割: ファイルの中身を表示したり、複数のファイルを繋げたりするコマンドです。

このスクリプトでの役割: 後述する <<EOF と組み合わせることで、**「ファイルを作らずに、その場で書いた文章をテキストデータとして出力する」**という役割をしています。

2. <<EOF とは何？（ヒアドキュメント）
これは 「ヒアドキュメント」 と呼ばれる機能です。

意味: 「次に EOF という文字が出てくるまで、書かれた内容を全部データとして扱え」という命令です。

EOF: End Of File の略で、単なる「しるし」です。実は EOF という名前である必要はなく、STOP でも APPLE でも、最初と最後が一致していれば何でも動きます（慣習的に EOF が使われます）。

3. () （カッコ）は何？
これは 「サブシェル（グループ化）」 という仕組みです。

役割: カッコの中にある複数の命令（この場合は cat とその中身）を、**「一つのグループ（一つの出力）」**としてまとめます。

なぜ必要か: カッコでまとめないと、パイプ（ | ）がどの部分を pfctl に渡せばいいのか混乱してしまうため、一つの「箱」に入れているイメージです。



macOSの通信制御システムである PF (Packet Filter) は、非常に多機能なため、役割ごとに「棚（アンカー）」の種類を分けて管理するルールになっています。
1. 役割の決定的な違い項目
dummynet-anchoranchor
役割通信の「加工」通信の「選別」中身帯域制限、遅延、パケットロスなどのルール。通信を許可する(pass)、遮断する(block)などのルール。命令語dummynet in/out pipe Xpass, block, nat, rdr など。イメージ「加工ライン」の指示書「入館ゲート」の指示書2. なぜ両方書く必要があるのか？PFというシステムは、通信パケットが届いたときに以下の2段階でチェックを行います。第1段階：このパケットの「スピード」はどうする？→ dummynet-anchor の中身を見に行く。ここに「1番パイプ（10Mbps）に通せ」と書いてあれば、パケットを土管に送ります。第2段階：このパケット自体を「通して」いいのか？→ anchor の中身を見に行く。ここに「この通信は許可（pass）」と書いてあれば、そのまま目的地へ流します。もし片方しか書かないと、システムは「スピードのルールはわかったけど、そもそもこれを通すべきかどうかの棚が定義されていないぞ？」と混乱してしまい、正しく動作しません。3. 同じ名前 "my_limit" を使っている理由Bashdummynet-anchor "my_limit"
anchor "my_limit"
ここで両方に同じ "my_limit" という名前をつけているのは、「この実験用セットアップ（my_limit）に関するルールは、スピードも許可設定もこの名前のグループでまとめて管理する」 という整理整頓のためです。OS内部では、同じ名前でも「スピード用の my_limit」と「許可・遮断用の my_limit」として別々の領域に保存されています。


(cat <<EOF ... EOF): ヒアドキュメントと呼ばれる手法です。EOFに囲まれた2行のテキストを、次のコマンドにまとめて流し込みます。

dummynet-anchor "my_limit": 帯域制限（dummynet）用の専用の「棚（アンカー）」を名前付きで作成します。

anchor "my_limit": 一般的なフィルタリングルール用の「棚」も作成します。

| sudo pfctl -f -: パイプ（|）を使って、上の2行を pfctl に読み込ませます。-f - は「標準入力から設定ファイルを読み込む」という意味です。

2>/dev/null: macOS特有の「ALTQがありません」といった不要な警告メッセージを非表示にします。

なぜこれが必要か？：Mac全体の元々の通信ルールを汚さず、自分専用の「砂場（my_limit）」を作って、そこで安全に実験するためです。



実験時のポイントまとめ操作コマンド備考速度を変えたいsudo dnctl pipe 1 config bw [速度]Mbit/spfctl はそのままでOK。遅延を消したいsudo dnctl pipe 1 config delay 0ms瞬時に反映されます。完全に解除したいsudo pfctl -dこれで元の高速通信に戻ります。


1. 下り通信（ダウンロード）の配管
Bash

echo "dummynet in all pipe 1" | sudo pfctl -a my_limit -f - 2>/dev/null
echo "dummynet in all pipe 1": 「全ての(all)、入ってくる(in)通信を、1番の土管(pipe 1)に流せ」というルール文を作ります。

sudo pfctl -a my_limit -f -:

-a my_limit: 先ほど作った「my_limit」という専用の棚の中に、このルールを格納します。

-f -: echo で送ったルールを読み込み、適用します。

3. 上り通信（アップロード）の配管
Bash

echo "dummynet out all pipe 2" | sudo pfctl -a my_limit -f - 2>/dev/null
echo "dummynet out all pipe 2": 「全ての(all)、出ていく(out)通信を、2番の土管(pipe 2)に流せ」というルール文を作ります。

ポイント: これで、「下りは10Mbpsの管、上りは2Mbpsの管」という別々の経路が完成します。

#    [予約語]  [方向] [対象] [予約語] [ID]
echo "dummynet   in    all    pipe     1"

もし all を書かずに dummynet in pipe 1 と書くと...
PF は「in（入ってくる通信）なのはわかったけど、具体的にどのパケット？ TCP だけ？ それとも特定のサイト宛だけ？」と迷ってしまい、結局「書き方が間違っています（Syntax error）」というエラーを出して、何も設定してくれません。

all 以外に何が書けるのか？
研究が進んで、「点群データのサーバー（TCP）だけ制限して、Zoom（UDP）は快適にしたい」といった場合に、all を書き換えることで対象を絞り込めます。

書き方,意味,使い道
all,全部,基本（今の実験はこれでOK）
proto tcp,TCP 通信だけ,Web ブラウザの通信だけを狙い撃ちする
to 1.2.3.4,特定の IP 宛だけ,特定のサーバーとの通信だけを遅くする
port 80,80番ポートだけ,暗号化されていない HTTP 通信だけを制限する



1. Packet Loss Rate (plr) ：パケットロス率
データのパケットを意図的に「捨てる」確率を設定します。

設定方法: plr 0.05（5%の確率でパケットを捨てる）のように指定します。

研究への影響: 農業現場やビニールハウスの端など、電波が不安定な場所ではパケットロスが頻繁に起きます。

点群データのバイナリが一部欠落した際、システムがフリーズせずに再送を待てるか？

描画が「穴あき」にならないか？ といった**「堅牢性（ロバストネス）」**の評価に必須の項目です。

2. Queue Size (queue / slots) ：バッファサイズ
土管の中にどれだけのデータを溜めておけるか（待ち行列の長さ）を設定します。

設定方法: queue 50（デフォルト）や queue 100 のように指定します。

研究への影響:

小さすぎると: すぐにデータがあふれてパケットロスが発生し、通信が不安定になります。

大きすぎると: ネット用語で言う 「バッファブロート（Bufferbloat）」 が発生します。データは届くものの、行列が長すぎて「ものすごく遅延（Delay）が増えた」ように感じます。

巨大な点群を「一気に」リクエストした際に、ブラウザの通信が破綻するかどうかを調べるのに使います。





「10Mbpsに設定したのに、なぜ結果がズレるのか」というのは、ネットワーク工学において非常に重要な視点です。
1. Downlink（8.378 Mbps）が「10」にならない理由これは実は、設定が正しく効いている証拠です。10Mbps（理論値）でセットしても、実際にデータが流れる際には 「オーバーヘッド（通信の梱包材）」 が必要だからです。データの梱包: 100のデータを送るには、送り先やエラーチェックなどの「ヘッダー情報」が付加されます。実効速度: ネットワークの理論値が10Mbpsの場合、実際に私たちが使える有効な速度（スループット）は、その 80%〜90% 程度 になるのが一般的です。$$10 \text{ Mbps} \times 0.85 (\text{効率}) \approx 8.5 \text{ Mbps}$$結論: Downlinkに関しては、設定した10Mbpsの土管（パイプ）をパケットがパンパンに詰まって通っている状態と言えます。



ネットワークエミュレーションツール「dummynet」明石邦夫
https://www.jstage.jst.go.jp/article/itej/64/10/64_1473/_pdf




https://scrapbox.io/rantarn0326-93726445/pfctl%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E3%81%AE%E4%BD%BF%E3%81%84%E6%96%B9


https://www.headspin.io/blog/simulating-different-network-conditions-for-virtual-devices


https://gist.github.com/mefellows/4f6ecd2e83de8b591726




etc/pf.conf　のバックアップから戻す方法

sudo cp /etc/pf.conf.bak /etc/pf.conf
sudo dnctl -q flush
sudo pfctl -f /etc/pf.conf




# 1. 下り（Downlink）のテスト
# -c: 接続先サーバー, -p: ポート, -t: 秒数, -R: サーバーから送信（下り）
iperf3 -c localhost -t 5 -R

# 2. 上り（Uplink）のテスト
# 通常モード（クライアントから送信）
iperf3 -c localhost -t 5


./network.sh
sudo dnctl show


Setup the server:

iperf -s
Run the client against the server for 7 seconds:

iperf -c localhost -t 7

iperf  -s -D # Run as Daemon (-D)
iperf -c localhost -t 5 

これでできる


brew install speedtest-cli
speedtest



今後検討すること：

ステップ1：シングル vs マルチストリームの飽和攻撃
Bash

# シングルストリーム（TCP 1本）
iperf3 -c localhost -t 5
# マルチストリーム（TCP 10本並列）
iperf3 -c localhost -t 5 -P 10
分析: 100Mbps設定時、1本だと先ほどのように 40Mbps に落ちるのか、10本なら 98Mbps 出るのか。これにより、「3Dアプリが、通信をどれだけ並列化（HTTP/2等の多重化）すべきか」 の理論的根拠が得られます。

ステップ2：UDPによる「パケット損失」の可視化
WebGPUを用いた可視化では、将来的に WebTransport (UDP) を使う可能性もあります。

Bash

# UDPで 100Mbps を流し込み、ロス率を測る
iperf3 -c localhost -u -b 100M -t 5
分析: TCPはロスを自動で隠蔽（再送）しますが、UDPは生のロスを表示します。dnctl の plr（パケットロス率）設定が、アプリのレンダリングにどう直結するかを分離して評価できます。

ステップ3：レイテンシとスループットの相関（BDP検証）
delay を 0ms, 50ms, 150ms と変えて、iperf3 のスループットがどう反比例するかをプロットします。


トランスポート層
アプリ層
物理層

それぞれのネットワーク制約をどのようにするかで評価指標は大きく変わる。また、トランスポート層においても　UDP（HTTP/3/QUIC）でもやった方が良い。
また、iperf3 ではなく tc + netem（Linux）　でやっても良い。

